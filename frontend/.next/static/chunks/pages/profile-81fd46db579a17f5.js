(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[277],{9344:function(e,r,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/profile",function(){return s(4317)}])},4317:function(e,r,s){"use strict";s.r(r),s.d(r,{default:function(){return d}});var t=s(5893),o=s(7294),n=s(1163),l=s(9008),a=s.n(l),i=s(3249);function d(){var e,r,s,l;let d=(0,n.useRouter)(),{isLoggedIn:c,setIsLoggedIn:m}=(0,o.useContext)(i.AuthContext),[u,h]=(0,o.useState)({name:"",email:"",role:"",studentDetails:{year:"",universityRollNumber:"",branch:"",mobileNumber:""}}),[x,f]=(0,o.useState)({name:"",currentPassword:"",newPassword:"",confirmPassword:"",mobileNumber:""}),[g,p]=(0,o.useState)(!1),[b,w]=(0,o.useState)(!0),[j,y]=(0,o.useState)(""),[N,v]=(0,o.useState)(""),[k,P]=(0,o.useState)("profile"),[C,L]=(0,o.useState)(0),[S,E]=(0,o.useState)(!1);(0,o.useEffect)(()=>{(async()=>{try{y("");let e=localStorage.getItem("token");if(!e){console.log("No token found, redirecting to login"),m(!1),d.push("/login?message=Please log in to view your profile");return}try{let r=await fetch("http://localhost:5000/api/users/verify-token",{method:"GET",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"}});if(!r.ok){if(console.error("Token verification failed:",r.status),401===r.status){T();return}throw Error("Failed to verify authentication token")}await M(e)}catch(r){console.error("Token verification error:",r),r.message.includes("fetch")||r.message.includes("network")?(console.log("Network error during token verification, trying profile fetch directly"),await M(e)):(y("Authentication error. Please try logging in again."),w(!1))}}catch(e){console.error("Authentication check error:",e),y("Authentication error. Please try logging in again."),w(!1)}})()},[d,C,m]);let T=()=>{console.log("Token expired or invalid, redirecting to login"),localStorage.removeItem("token"),m(!1),E(!0),y("Your session has expired. Please log in again."),w(!1)},M=async e=>{try{w(!0),y(""),console.log("Fetching user profile...");let s=new AbortController,t=setTimeout(()=>s.abort(),1e4);try{try{(await fetch("http://localhost:5000",{method:"GET",signal:s.signal,cache:"no-store"})).ok?console.log("Server is available"):console.log("Server ping failed, server might be down")}catch(e){console.log("Could not reach the server:",e.message)}let o=await fetch("http://localhost:5000/api/users/profile",{method:"GET",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json",Accept:"application/json","Cache-Control":"no-cache, no-store"},signal:s.signal});if(clearTimeout(t),console.log("Profile response status:",o.status),o.ok){var r;let e=await o.json();if(console.log("Profile data received:",e),!e)throw Error("Received empty data from server");h(e),f({name:e.name||"",currentPassword:"",newPassword:"",confirmPassword:"",mobileNumber:(null===(r=e.studentDetails)||void 0===r?void 0:r.mobileNumber)||""}),m(!0),y("")}else{let e="Failed to fetch profile";try{let r=await o.json();console.error("Profile fetch error:",r),e=r.message||e}catch(e){console.error("Error parsing error response:",e)}if(401===o.status){T();return}y(e),C<3&&(o.status>=500||0===o.status)&&(console.log("Retrying profile fetch (".concat(C+1,"/").concat(3,")...")),setTimeout(()=>{L(e=>e+1)},1e3*Math.pow(2,C)))}}catch(e){clearTimeout(t),"AbortError"===e.name?(console.error("Request timed out"),y("Request timed out. The server took too long to respond.")):(console.error("Fetch error:",e),y("Network error while fetching profile. Please check your connection.")),C<3&&(console.log("Retrying profile fetch (".concat(C+1,"/").concat(3,")...")),setTimeout(()=>{L(e=>e+1)},1e3*Math.pow(2,C)))}}catch(e){console.error("Profile fetch outer error:",e),y("Network error while fetching profile. Please check your connection."),C<3&&(console.log("Retrying profile fetch (".concat(C+1,"/").concat(3,")...")),setTimeout(()=>{L(e=>e+1)},1e3*Math.pow(2,C)))}finally{w(!1)}},A=e=>{let{name:r,value:s}=e.target;f(e=>({...e,[r]:s}))},D=async e=>{if(e.preventDefault(),y(""),v(""),x.newPassword&&x.newPassword!==x.confirmPassword){y("New passwords do not match");return}try{console.log("Updating profile...");let e=localStorage.getItem("token");if(!e){y("Not authenticated. Please log in again."),d.push("/login");return}let s={name:x.name};x.currentPassword&&x.newPassword&&(s.currentPassword=x.currentPassword,s.newPassword=x.newPassword),x.mobileNumber&&(s.studentDetails={...u.studentDetails,mobileNumber:x.mobileNumber}),console.log("Sending update request with data:",s);let t=await fetch("http://localhost:5000/api/users/profile",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)},body:JSON.stringify(s)});if(console.log("Update response status:",t.status),t.ok){var r;let e=await t.json();console.log("Profile updated successfully:",e),h(e),v("Profile updated successfully"),p(!1),f({name:e.name,currentPassword:"",newPassword:"",confirmPassword:"",mobileNumber:(null===(r=e.studentDetails)||void 0===r?void 0:r.mobileNumber)||""})}else{let e="Failed to update profile";try{let r=await t.json();console.error("Profile update error:",r),e=r.message||e}catch(e){console.error("Error parsing error response:",e)}if(401===t.status){localStorage.removeItem("token"),m(!1),d.push("/login?expired=true");return}y(e)}}catch(e){console.error("Profile update error:",e),y("Network error while updating profile. Please check your connection.")}};return S?(0,t.jsx)("div",{className:"min-h-screen bg-gray-50 flex flex-col justify-center items-center py-12 sm:px-6 lg:px-8",children:(0,t.jsx)("div",{className:"mt-8 sm:mx-auto sm:w-full sm:max-w-md",children:(0,t.jsxs)("div",{className:"bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10",children:[(0,t.jsx)("div",{className:"bg-red-50 border-l-4 border-red-400 p-4 mb-6",children:(0,t.jsxs)("div",{className:"flex",children:[(0,t.jsx)("div",{className:"flex-shrink-0",children:(0,t.jsx)("svg",{className:"h-5 w-5 text-red-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})})}),(0,t.jsx)("div",{className:"ml-3",children:(0,t.jsx)("p",{className:"text-sm text-red-700",children:"Your session has expired. Please log in again to access your profile."})})]})}),(0,t.jsx)("div",{className:"mt-6",children:(0,t.jsx)("button",{type:"button",onClick:()=>d.push("/login?redirect=/profile"),className:"w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:"Go to Login Page"})})]})})}):b?(0,t.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,t.jsxs)("div",{className:"relative w-24 h-24",children:[(0,t.jsx)("div",{className:"absolute top-0 left-0 w-full h-full border-4 border-blue-200 rounded-full animate-ping opacity-75"}),(0,t.jsx)("div",{className:"absolute top-0 left-0 w-full h-full border-4 border-t-blue-600 border-b-blue-600 border-l-transparent border-r-transparent rounded-full animate-spin"})]})}):(0,t.jsxs)("div",{children:[(0,t.jsx)(a(),{children:(0,t.jsx)("title",{children:"My Profile - GNDEC Grievance Portal"})}),(0,t.jsx)("div",{className:"min-h-screen bg-gradient-to-b from-white to-blue-50 py-12 px-4 sm:px-6 lg:px-8",children:(0,t.jsxs)("div",{className:"max-w-4xl mx-auto",children:[j&&j.includes("Network error")&&(0,t.jsxs)("div",{className:"mb-6 bg-red-50 border-l-4 border-red-500 p-4 rounded-md",role:"alert",children:[(0,t.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center mb-3 sm:mb-0",children:[(0,t.jsx)("svg",{className:"h-6 w-6 mr-3 text-red-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h3",{className:"text-sm font-medium text-red-800",children:"Connection Error"}),(0,t.jsx)("p",{className:"text-sm text-red-700 mt-1",children:j})]})]}),(0,t.jsxs)("button",{onClick:()=>{L(e=>e+1)},className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-150",children:[(0,t.jsx)("svg",{className:"h-4 w-4 mr-1.5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})}),"Retry Connection"]})]}),(0,t.jsxs)("div",{className:"mt-3 text-sm text-red-700",children:[(0,t.jsx)("p",{children:"Troubleshooting tips:"}),(0,t.jsxs)("ul",{className:"list-disc pl-5 mt-1 space-y-1",children:[(0,t.jsx)("li",{children:"Check if the backend server is running"}),(0,t.jsx)("li",{children:"Verify your internet connection"}),(0,t.jsx)("li",{children:"Try refreshing the page"}),(0,t.jsx)("li",{children:"Log out and log back in"})]})]})]}),j&&!j.includes("Network error")&&(0,t.jsxs)("div",{className:"mb-6 bg-red-50 border-l-4 border-red-500 text-red-600 p-4 rounded-md flex items-center",role:"alert",children:[(0,t.jsx)("svg",{className:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})}),(0,t.jsx)("span",{children:j})]}),N&&(0,t.jsxs)("div",{className:"mb-6 bg-green-50 border-l-4 border-green-500 text-green-600 p-4 rounded-md flex items-center",role:"alert",children:[(0,t.jsx)("svg",{className:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})}),(0,t.jsx)("span",{children:N})]}),(0,t.jsx)("div",{className:"bg-white rounded-xl shadow-lg overflow-hidden",children:(0,t.jsxs)("div",{className:"md:flex",children:[(0,t.jsxs)("div",{className:"bg-gradient-to-b from-blue-700 to-blue-900 text-white p-6 md:w-64 flex flex-col items-center",children:[(0,t.jsxs)("div",{className:"mb-8 text-center",children:[(0,t.jsx)("div",{className:"h-32 w-32 rounded-full bg-white flex items-center justify-center text-blue-800 text-5xl font-bold mb-4 shadow-lg border-4 border-white",children:u.name?u.name.charAt(0).toUpperCase():"?"}),(0,t.jsx)("h2",{className:"text-xl font-bold",children:u.name}),(0,t.jsx)("p",{className:"text-blue-200 capitalize",children:u.role||"Student"})]}),(0,t.jsxs)("nav",{className:"w-full",children:[(0,t.jsxs)("button",{onClick:()=>P("profile"),className:"w-full text-left py-3 px-4 rounded-lg mb-2 flex items-center transition-all duration-200 ".concat("profile"===k?"bg-white text-blue-800 font-medium shadow-md":"hover:bg-blue-800 text-blue-100"),children:[(0,t.jsx)("svg",{className:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})}),"Profile Information"]}),(0,t.jsxs)("button",{onClick:()=>{P("security"),g&&p(!0)},className:"w-full text-left py-3 px-4 rounded-lg mb-2 flex items-center transition-all duration-200 ".concat("security"===k?"bg-white text-blue-800 font-medium shadow-md":"hover:bg-blue-800 text-blue-100"),children:[(0,t.jsx)("svg",{className:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"})}),"Security"]})]})]}),(0,t.jsxs)("div",{className:"flex-1 p-8",children:[(0,t.jsxs)("div",{className:"flex justify-between items-center mb-8",children:[(0,t.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:"profile"===k?"Profile Information":"Security Settings"}),g?(0,t.jsxs)("button",{onClick:()=>p(!1),className:"inline-flex items-center px-4 py-2 bg-gray-200 text-gray-700 text-sm font-medium rounded-md shadow hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-all duration-200",children:[(0,t.jsx)("svg",{className:"h-4 w-4 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),"Cancel"]}):(0,t.jsxs)("button",{onClick:()=>p(!0),className:"inline-flex items-center px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white text-sm font-medium rounded-md shadow hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 transform hover:-translate-y-0.5",children:[(0,t.jsx)("svg",{className:"h-4 w-4 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"})}),"Edit Profile"]})]}),"profile"===k&&(0,t.jsx)(t.Fragment,{children:g?(0,t.jsx)("form",{onSubmit:D,className:"space-y-6",children:(0,t.jsxs)("div",{className:"bg-white p-6 rounded-lg border border-gray-200",children:[(0,t.jsxs)("div",{className:"mb-5",children:[(0,t.jsx)("label",{htmlFor:"name",className:"block text-sm font-medium text-gray-700 mb-1",children:"Full Name"}),(0,t.jsx)("input",{type:"text",name:"name",id:"name",value:x.name,onChange:A,required:!0,className:"form-input w-full px-4 py-2 border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"})]}),(0,t.jsxs)("div",{className:"mb-5",children:[(0,t.jsx)("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 mb-1",children:"Email Address (cannot be changed)"}),(0,t.jsx)("input",{type:"email",id:"email",value:u.email,disabled:!0,className:"w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-500"})]}),(0,t.jsxs)("div",{className:"mb-5",children:[(0,t.jsx)("label",{htmlFor:"mobileNumber",className:"block text-sm font-medium text-gray-700 mb-1",children:"Mobile Number"}),(0,t.jsx)("input",{type:"text",name:"mobileNumber",id:"mobileNumber",value:x.mobileNumber,onChange:A,className:"form-input w-full px-4 py-2 border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter your mobile number"})]}),(0,t.jsx)("div",{className:"flex justify-end",children:(0,t.jsx)("button",{type:"submit",className:"inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200",children:"Save Changes"})})]})}):(0,t.jsx)("div",{className:"bg-white rounded-lg border border-gray-200",children:(0,t.jsxs)("dl",{className:"divide-y divide-gray-200",children:[(0,t.jsxs)("div",{className:"px-6 py-4 grid grid-cols-3 gap-4",children:[(0,t.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"Full Name"}),(0,t.jsx)("dd",{className:"text-sm text-gray-900 col-span-2",children:u.name})]}),(0,t.jsxs)("div",{className:"px-6 py-4 grid grid-cols-3 gap-4",children:[(0,t.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"Email Address"}),(0,t.jsx)("dd",{className:"text-sm text-gray-900 col-span-2",children:u.email})]}),(0,t.jsxs)("div",{className:"px-6 py-4 grid grid-cols-3 gap-4",children:[(0,t.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"Role"}),(0,t.jsx)("dd",{className:"text-sm capitalize text-gray-900 col-span-2",children:(0,t.jsx)("span",{className:"inline-flex items-center px-3 py-0.5 rounded-full text-sm font-medium bg-blue-100 text-blue-800",children:u.role||"Student"})})]}),(null===(e=u.studentDetails)||void 0===e?void 0:e.universityRollNumber)&&(0,t.jsxs)("div",{className:"px-6 py-4 grid grid-cols-3 gap-4",children:[(0,t.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"University Roll No."}),(0,t.jsx)("dd",{className:"text-sm text-gray-900 col-span-2",children:u.studentDetails.universityRollNumber})]}),(null===(r=u.studentDetails)||void 0===r?void 0:r.branch)&&(0,t.jsxs)("div",{className:"px-6 py-4 grid grid-cols-3 gap-4",children:[(0,t.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"Branch"}),(0,t.jsx)("dd",{className:"text-sm text-gray-900 col-span-2",children:u.studentDetails.branch})]}),(null===(s=u.studentDetails)||void 0===s?void 0:s.year)&&(0,t.jsxs)("div",{className:"px-6 py-4 grid grid-cols-3 gap-4",children:[(0,t.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"Year"}),(0,t.jsx)("dd",{className:"text-sm text-gray-900 col-span-2",children:u.studentDetails.year})]}),(0,t.jsxs)("div",{className:"px-6 py-4 grid grid-cols-3 gap-4",children:[(0,t.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"Mobile Number"}),(0,t.jsx)("dd",{className:"text-sm text-gray-900 col-span-2",children:(null===(l=u.studentDetails)||void 0===l?void 0:l.mobileNumber)||"Not provided"})]})]})})}),"security"===k&&(0,t.jsx)("form",{onSubmit:D,className:"space-y-6",children:(0,t.jsxs)("div",{className:"bg-white p-6 rounded-lg border border-gray-200",children:[(0,t.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Change Password"}),(0,t.jsxs)("div",{className:"mb-5",children:[(0,t.jsx)("label",{htmlFor:"currentPassword",className:"block text-sm font-medium text-gray-700 mb-1",children:"Current Password"}),(0,t.jsx)("input",{type:"password",name:"currentPassword",id:"currentPassword",value:x.currentPassword,onChange:A,className:"form-input w-full px-4 py-2 border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter your current password",required:!!x.newPassword})]}),(0,t.jsxs)("div",{className:"mb-5",children:[(0,t.jsx)("label",{htmlFor:"newPassword",className:"block text-sm font-medium text-gray-700 mb-1",children:"New Password"}),(0,t.jsx)("input",{type:"password",name:"newPassword",id:"newPassword",value:x.newPassword,onChange:A,className:"form-input w-full px-4 py-2 border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter new password",required:!!x.currentPassword}),(0,t.jsx)("p",{className:"mt-1 text-xs text-gray-500",children:"Password should be at least 8 characters long"})]}),(0,t.jsxs)("div",{className:"mb-5",children:[(0,t.jsx)("label",{htmlFor:"confirmPassword",className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm New Password"}),(0,t.jsx)("input",{type:"password",name:"confirmPassword",id:"confirmPassword",value:x.confirmPassword,onChange:A,className:"form-input w-full px-4 py-2 border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500",placeholder:"Confirm new password",required:!!x.newPassword})]}),(0,t.jsx)("div",{className:"pt-4 border-t border-gray-200 mt-6",children:(0,t.jsx)("div",{className:"flex justify-end",children:(0,t.jsx)("button",{type:"submit",className:"inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200",children:"Update Password"})})})]})})]})]})})]})})]})}}},function(e){e.O(0,[888,774,179],function(){return e(e.s=9344)}),_N_E=e.O()}]);